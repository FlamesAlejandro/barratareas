"use strict";function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var passport=require("passport"),Usuarios=require("../Models/Usuarios"),crypto=require("crypto"),Sequelize=require("sequelize"),Op=Sequelize.Op,bcrypt=require("bcrypt-nodejs"),enviarEmail=require("../handlers/email");exports.autenticarUsuario=passport.authenticate("local",{successRedirect:"/",failureRedirect:"/iniciar-sesion",failureFlash:!0,badRequestMessage:"Ambos campos son obligatorios"}),exports.usuarioAutenticado=function(e,r,t){return e.isAuthenticated()?t():r.redirect("/iniciar-sesion")},exports.cerrarSesion=function(e,r){e.session.destroy(function(){r.redirect("/iniciar-sesion")})},exports.enviarToken=function(r,t){var a,n,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return a=r.body.email,e.next=3,regeneratorRuntime.awrap(Usuarios.findOne({where:{email:a}}));case 3:return(n=e.sent)||(r.flash("error","No existe esa cuenta"),t.redirect("/reestablecer")),n.token=crypto.randomBytes(20).toString("hex"),n.expiracion=Date.now()+36e5,e.next=9,regeneratorRuntime.awrap(n.save());case 9:return s="http://".concat(r.headers.host,"/reestablecer/").concat(n.token),e.next=12,regeneratorRuntime.awrap(enviarEmail.enviar({usuario:n,subject:"Password Reset",resetUrl:s,archivo:"reestablecerPassword"}));case 12:r.flash("correcto","Se envió un mensaje a tu correo"),t.redirect("/iniciar-sesion");case 14:case"end":return e.stop()}})},exports.validarToken=function(r,t){var a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Usuarios.findOne({where:{token:r.params.token}}));case 2:a=e.sent,console.log("antes "+a.email+" y el token es"+r.params.token),a||(r.flash("error","No Válido"),t.redirect("/reestablecer")),t.render("resetPassword",{nombrePagina:"Reestablecer Password"});case 6:case"end":return e.stop()}})},exports.actualizarPassword=function(r,t){var a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Usuarios.findOne({where:{token:r.params.token,expiracion:_defineProperty({},Op.gte,Date.now())}}));case 2:return(a=e.sent)||(r.flash("error","No válido"),t.redirect("/reestablecer")),a.password=bcrypt.hashSync(r.body.password,bcrypt.genSaltSync(10)),a.token=null,a.expiracion=null,e.next=9,regeneratorRuntime.awrap(a.save());case 9:r.flash("correcto","Tu password se ha modificado correctamente"),t.redirect("/iniciar-sesion");case 11:case"end":return e.stop()}})};